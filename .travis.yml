language: ruby
cache:
 directories:
  - docker
services:
- docker
before_script:
 - gzip -dc docker/rails.tar.gz | docker load || true
script:
- env
- echo ${RAILS_SECRET}
- docker build -t rails:latest --build-arg secret=${RAILS_SECRET} .
- docker run --name rails -e RAILS_ENV=test rails ./bin/rspec
- docker save rails | gzip > docker/rails.tar.gz || true
deploy:
  provider: heroku
  api_key: $APIKEY
  run:
  - heroku container:login
  - heroku container:push web
  - heroku container:release web
